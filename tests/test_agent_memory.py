#!/usr/bin/env python3\n\"\"\"\nå…¨æ–°Agentè®°å¿†ç³»ç»ŸéªŒè¯æµ‹è¯•\nåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„Agentæ¥éªŒè¯è®°å¿†ç³»ç»Ÿæ˜¯å¦çœŸæ­£å¯ä»¥æ­£å¸¸å·¥ä½œ\n\"\"\"\nimport asyncio\nimport sys\nfrom pathlib import Path\nfrom typing import List, Dict, Any\n\n# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„\nsys.path.append(str(Path(__file__).parent.parent))\n\nfrom langchain_core.messages import HumanMessage, AIMessage, SystemMessage\nfrom langchain_core.tools import BaseTool\nfrom langgraph.graph import StateGraph, START\n\nfrom app.agents.core.base import BaseAgent, AgentState\nfrom app.agents.core.interfaces import AgentType\nfrom app.models.core.base import ModelAdapter\n\n\nclass MockModelAdapter:\n    \"\"\"å¢å¼ºçš„æ¨¡æ‹Ÿæ¨¡å‹é€‚é…å™¨ï¼Œè¯¦ç»†è®°å½•æ‰€æœ‰è°ƒç”¨\"\"\"\n    \n    def __init__(self):\n        self.call_history = []\n        self.call_count = 0\n    \n    async def ainvoke(self, messages):\n        \"\"\"æ¨¡æ‹Ÿæ¨¡å‹è°ƒç”¨\"\"\"\n        self.call_count += 1\n        \n        # è®°å½•è°ƒç”¨è¯¦æƒ…\n        call_info = {\n            'call_number': self.call_count,\n            'message_count': len(messages),\n            'messages': [{'type': type(msg).__name__, 'content': getattr(msg, 'content', str(msg))} for msg in messages]\n        }\n        self.call_history.append(call_info)\n        \n        # æ ¹æ®æ¶ˆæ¯å†…å®¹ç”Ÿæˆä¸åŒçš„å“åº”\n        last_message = messages[-1] if messages else None\n        if last_message and hasattr(last_message, 'content'):\n            content = last_message.content.lower()\n            \n            if 'è®°ä½' in content or 'remember' in content:\n                response = f\"å¥½çš„ï¼Œæˆ‘å·²ç»è®°ä½äº†ï¼š{last_message.content}\"\n            elif 'å›å¿†' in content or 'recall' in content:\n                response = \"æ ¹æ®æˆ‘çš„è®°å¿†ï¼Œä¹‹å‰æˆ‘ä»¬è®¨è®ºè¿‡ç›¸å…³å†…å®¹ã€‚\"\n            elif 'æµ‹è¯•' in content or 'test' in content:\n                response = f\"è¿™æ˜¯æµ‹è¯•å“åº” #{self.call_count}ï¼Œæˆ‘æ”¶åˆ°äº†æ‚¨çš„æ¶ˆæ¯ã€‚\"\n            else:\n                response = f\"æˆ‘ç†è§£äº†æ‚¨çš„æ¶ˆæ¯ï¼ˆè°ƒç”¨ #{self.call_count}ï¼‰ã€‚\"\n        else:\n            response = f\"é»˜è®¤å“åº”ï¼ˆè°ƒç”¨ #{self.call_count}ï¼‰\"\n        \n        # æ¨¡æ‹ŸAIMessageå“åº”\n        class MockAIMessage:\n            def __init__(self, content):\n                self.content = content\n                self.type = 'ai'\n        \n        return MockAIMessage(response)\n    \n    async def astream(self, messages):\n        \"\"\"æ¨¡æ‹Ÿæµå¼å“åº”\"\"\"\n        response = await self.ainvoke(messages)\n        # å°†å“åº”åˆ†å—è¿”å›\n        words = response.content.split()\n        for word in words:\n            class MockChunk:\n                def __init__(self, content):\n                    self.content = content\n            yield MockChunk(word + \" \")\n    \n    def get_call_summary(self):\n        \"\"\"è·å–è°ƒç”¨æ‘˜è¦\"\"\"\n        return {\n            'total_calls': self.call_count,\n            'call_history': self.call_history\n        }\n\n\nclass MemoryTestAgent(BaseAgent):\n    \"\"\"ä¸“é—¨ç”¨äºæµ‹è¯•è®°å¿†åŠŸèƒ½çš„Agent\"\"\"\n    \n    def __init__(self, model_adapter: ModelAdapter, **kwargs):\n        super().__init__(model_adapter, **kwargs)\n        self.conversation_memory = []  # ç®€å•çš„å¯¹è¯è®°å¿†\n        self.test_results = []  # æµ‹è¯•ç»“æœè®°å½•\n    \n    @property\n    def agent_type(self) -> AgentType:\n        return AgentType.CUSTOM\n    \n    def _create_workflow(self) -> StateGraph:\n        \"\"\"åˆ›å»ºåŒ…å«è®°å¿†åŠŸèƒ½çš„å·¥ä½œæµ\"\"\"\n        workflow = StateGraph(AgentState)\n        \n        # æ·»åŠ èŠ‚ç‚¹\n        workflow.add_node(\"memory_check\", self._check_memory)\n        workflow.add_node(\"process_input\", self._process_input)\n        workflow.add_node(\"update_memory\", self._update_memory)\n        workflow.add_node(\"generate_response\", self._generate_response)\n        \n        # å®šä¹‰æµç¨‹\n        workflow.add_edge(START, \"memory_check\")\n        workflow.add_edge(\"memory_check\", \"process_input\")\n        workflow.add_edge(\"process_input\", \"update_memory\")\n        workflow.add_edge(\"update_memory\", \"generate_response\")\n        workflow.add_edge(\"generate_response\", \"__end__\")\n        \n        return workflow\n    \n    async def _check_memory(self, state: AgentState) -> AgentState:\n        \"\"\"æ£€æŸ¥è®°å¿†çŠ¶æ€\"\"\"\n        memory_info = {\n            'memory_count': len(self.conversation_memory),\n            'last_interactions': self.conversation_memory[-3:] if self.conversation_memory else []\n        }\n        \n        # æ·»åŠ è®°å¿†ä¿¡æ¯åˆ°çŠ¶æ€\n        state['memory_info'] = memory_info\n        \n        self.test_results.append({\n            'step': 'memory_check',\n            'memory_count': len(self.conversation_memory),\n            'status': 'completed'\n        })\n        \n        return state\n    \n    async def _process_input(self, state: AgentState) -> AgentState:\n        \"\"\"å¤„ç†è¾“å…¥\"\"\"\n        user_input = state.get('user_input', '')\n        \n        # åˆ†æè¾“å…¥ç±»å‹\n        input_analysis = {\n            'is_memory_command': any(keyword in user_input.lower() for keyword in ['è®°ä½', 'å›å¿†', 'remember', 'recall']),\n            'is_test_command': 'æµ‹è¯•' in user_input.lower() or 'test' in user_input.lower(),\n            'input_length': len(user_input)\n        }\n        \n        state['input_analysis'] = input_analysis\n        \n        self.test_results.append({\n            'step': 'process_input',\n            'analysis': input_analysis,\n            'status': 'completed'\n        })\n        \n        return state\n    \n    async def _update_memory(self, state: AgentState) -> AgentState:\n        \"\"\"æ›´æ–°è®°å¿†\"\"\"\n        user_input = state.get('user_input', '')\n        \n        # æ·»åŠ åˆ°å¯¹è¯è®°å¿†\n        memory_entry = {\n            'timestamp': asyncio.get_event_loop().time(),\n            'user_input': user_input,\n            'memory_size_before': len(self.conversation_memory)\n        }\n        \n        self.conversation_memory.append(memory_entry)\n        \n        state['memory_updated'] = True\n        state['current_memory_size'] = len(self.conversation_memory)\n        \n        self.test_results.append({\n            'step': 'update_memory',\n            'memory_size': len(self.conversation_memory),\n            'status': 'completed'\n        })\n        \n        return state\n    \n    async def _generate_response(self, state: AgentState) -> AgentState:\n        \"\"\"ç”Ÿæˆå“åº”\"\"\"\n        # æ„å»ºåŒ…å«è®°å¿†ä¿¡æ¯çš„æ¶ˆæ¯\n        messages = []\n        \n        # ç³»ç»Ÿæ¶ˆæ¯\n        system_msg = SystemMessage(content=\"ä½ æ˜¯ä¸€ä¸ªå…·æœ‰è®°å¿†åŠŸèƒ½çš„AIåŠ©æ‰‹ï¼Œèƒ½å¤Ÿè®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚\")\n        messages.append(system_msg)\n        \n        # æ·»åŠ è®°å¿†ä¸Šä¸‹æ–‡\n        if self.conversation_memory:\n            memory_context = \"ä¹‹å‰çš„å¯¹è¯è®°å½•ï¼š\\n\"\n            for i, entry in enumerate(self.conversation_memory[-3:], 1):  # åªåŒ…å«æœ€è¿‘3æ¡\n                memory_context += f\"{i}. {entry['user_input']}\\n\"\n            \n            context_msg = SystemMessage(content=memory_context)\n            messages.append(context_msg)\n        \n        # å½“å‰ç”¨æˆ·è¾“å…¥\n        user_input = state.get('user_input', '')\n        user_msg = HumanMessage(content=user_input)\n        messages.append(user_msg)\n        \n        # è°ƒç”¨æ¨¡å‹\n        try:\n            response = await self.model_adapter.ainvoke(messages)\n            state['response'] = response.content\n            state['model_called'] = True\n            \n            self.test_results.append({\n                'step': 'generate_response',\n                'response_generated': True,\n                'response_length': len(response.content),\n                'status': 'completed'\n            })\n            \n        except Exception as e:\n            state['response'] = f\"ç”Ÿæˆå“åº”æ—¶å‡ºé”™: {str(e)}\"\n            state['model_called'] = False\n            \n            self.test_results.append({\n                'step': 'generate_response',\n                'error': str(e),\n                'status': 'failed'\n            })\n        \n        return state\n    \n    def get_memory_stats(self):\n        \"\"\"è·å–è®°å¿†ç»Ÿè®¡ä¿¡æ¯\"\"\"\n        return {\n            'total_memories': len(self.conversation_memory),\n            'memory_entries': self.conversation_memory,\n            'test_results': self.test_results\n        }\n\n\nasync def test_agent_memory_system():\n    \"\"\"æµ‹è¯•Agentè®°å¿†ç³»ç»Ÿçš„å®Œæ•´åŠŸèƒ½\"\"\"\n    print(\"ğŸ§  å¼€å§‹Agentè®°å¿†ç³»ç»Ÿæµ‹è¯•\")\n    print(\"=\" * 50)\n    \n    # åˆ›å»ºæ¨¡æ‹Ÿæ¨¡å‹é€‚é…å™¨\n    mock_adapter = MockModelAdapter()\n    \n    # åˆ›å»ºæµ‹è¯•Agent\n    test_agent = MemoryTestAgent(\n        model_adapter=mock_adapter,\n        name=\"è®°å¿†æµ‹è¯•Agent\",\n        description=\"ä¸“é—¨ç”¨äºæµ‹è¯•è®°å¿†åŠŸèƒ½çš„Agent\"\n    )\n    \n    # æµ‹è¯•ç”¨ä¾‹\n    test_cases = [\n        \"è¯·è®°ä½æˆ‘çš„åå­—æ˜¯å¼ ä¸‰\",\n        \"æˆ‘ä»Šå¤©å¾ˆå¼€å¿ƒ\",\n        \"è¯·å›å¿†ä¸€ä¸‹æˆ‘ä¹‹å‰è¯´è¿‡ä»€ä¹ˆ\",\n        \"æµ‹è¯•è®°å¿†åŠŸèƒ½æ˜¯å¦æ­£å¸¸\",\n        \"æˆ‘çš„çˆ±å¥½æ˜¯è¯»ä¹¦å’Œæ—…è¡Œ\"\n    ]\n    \n    print(f\"ğŸ“ å‡†å¤‡æ‰§è¡Œ {len(test_cases)} ä¸ªæµ‹è¯•ç”¨ä¾‹\")\n    print()\n    \n    # æ‰§è¡Œæµ‹è¯•\n    for i, test_input in enumerate(test_cases, 1):\n        print(f\"ğŸ” æµ‹è¯•ç”¨ä¾‹ {i}: {test_input}\")\n        \n        try:\n            # è°ƒç”¨Agent\n            result = await test_agent.ainvoke(test_input)\n            \n            print(f\"âœ… å“åº”: {result}\")\n            print(f\"ğŸ“Š å½“å‰è®°å¿†æ•°é‡: {len(test_agent.conversation_memory)}\")\n            \n        except Exception as e:\n            print(f\"âŒ æµ‹è¯•å¤±è´¥: {str(e)}\")\n        \n        print(\"-\" * 30)\n    \n    # è¾“å‡ºè¯¦ç»†ç»Ÿè®¡\n    print(\"\\nğŸ“ˆ æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯:\")\n    print(\"=\" * 50)\n    \n    # Agentè®°å¿†ç»Ÿè®¡\n    memory_stats = test_agent.get_memory_stats()\n    print(f\"ğŸ§  Agentè®°å¿†ç»Ÿè®¡:\")\n    print(f\"   æ€»è®°å¿†æ¡ç›®: {memory_stats['total_memories']}\")\n    print(f\"   æµ‹è¯•æ­¥éª¤å®Œæˆ: {len(memory_stats['test_results'])}\")\n    \n    # æ¨¡å‹è°ƒç”¨ç»Ÿè®¡\n    model_stats = mock_adapter.get_call_summary()\n    print(f\"\\nğŸ¤– æ¨¡å‹è°ƒç”¨ç»Ÿè®¡:\")\n    print(f\"   æ€»è°ƒç”¨æ¬¡æ•°: {model_stats['total_calls']}\")\n    \n    # è¯¦ç»†çš„è°ƒç”¨å†å²\n    print(f\"\\nğŸ“‹ è¯¦ç»†è°ƒç”¨å†å²:\")\n    for call in model_stats['call_history']:\n        print(f\"   è°ƒç”¨ #{call['call_number']}: {call['message_count']} æ¡æ¶ˆæ¯\")\n    \n    # è®°å¿†å†…å®¹è¯¦æƒ…\n    print(f\"\\nğŸ’­ è®°å¿†å†…å®¹è¯¦æƒ…:\")\n    for i, memory in enumerate(memory_stats['memory_entries'], 1):\n        print(f\"   è®°å¿† {i}: {memory['user_input'][:50]}...\")\n    \n    # æµ‹è¯•ç»“æœæ±‡æ€»\n    print(f\"\\nğŸ¯ æµ‹è¯•ç»“æœæ±‡æ€»:\")\n    successful_steps = sum(1 for result in memory_stats['test_results'] if result['status'] == 'completed')\n    total_steps = len(memory_stats['test_results'])\n    print(f\"   æˆåŠŸæ­¥éª¤: {successful_steps}/{total_steps}\")\n    print(f\"   æˆåŠŸç‡: {successful_steps/total_steps*100:.1f}%\")\n    \n    # éªŒè¯è®°å¿†ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ\n    memory_working = memory_stats['total_memories'] > 0\n    model_working = model_stats['total_calls'] > 0\n    \n    print(f\"\\nğŸ” ç³»ç»ŸéªŒè¯:\")\n    print(f\"   è®°å¿†ç³»ç»Ÿ: {'âœ… æ­£å¸¸' if memory_working else 'âŒ å¼‚å¸¸'}\")\n    print(f\"   æ¨¡å‹è°ƒç”¨: {'âœ… æ­£å¸¸' if model_working else 'âŒ å¼‚å¸¸'}\")\n    \n    overall_success = memory_working and model_working\n    print(f\"   æ•´ä½“çŠ¶æ€: {'ğŸ‰ æµ‹è¯•é€šè¿‡' if overall_success else 'âš ï¸ æµ‹è¯•å¤±è´¥'}\")\n    \n    return overall_success\n\n\nif __name__ == \"__main__\":\n    print(\"ğŸš€ å¯åŠ¨Agentè®°å¿†ç³»ç»ŸéªŒè¯æµ‹è¯•\")\n    print(\"è¿™ä¸ªæµ‹è¯•å°†éªŒè¯Agentæ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åœ°è®°ä½å’Œå›å¿†å¯¹è¯å†…å®¹\")\n    print()\n    \n    try:\n        # è¿è¡Œæµ‹è¯•\n        success = asyncio.run(test_agent_memory_system())\n        \n        if success:\n            print(\"\\nğŸŠ æ­å–œï¼Agentè®°å¿†ç³»ç»Ÿæµ‹è¯•å®Œå…¨é€šè¿‡ï¼\")\n            print(\"Agentèƒ½å¤Ÿæ­£ç¡®åœ°è®°ä½å¯¹è¯å†…å®¹å¹¶åœ¨åç»­äº¤äº’ä¸­ä½¿ç”¨è¿™äº›è®°å¿†ã€‚\")\n        else:\n            print(\"\\nâš ï¸ æµ‹è¯•å‘ç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥Agentè®°å¿†ç³»ç»Ÿçš„å®ç°ã€‚\")\n            \n    except Exception as e:\n        print(f\"\\nğŸ’¥ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯: {str(e)}\")\n        import traceback\n        traceback.print_exc()\n    \n    print(\"\\næµ‹è¯•å®Œæˆã€‚\")"